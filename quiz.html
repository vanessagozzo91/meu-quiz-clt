<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Formulário de Pré-Qualificação</title>
    <script>
        const PIXEL_ID = 'SEU_PIXEL_ID'; 
        const APPS_SCRIPT_URL = 'SUA_URL_DO_APPS_SCRIPT_DEPLOY'; // Substitua pela URL do Deploy

        // Inicialização padrão do Meta Pixel
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', PIXEL_ID);
        fbq('track', 'PageView');
        
        // ===================================================================
        // FUNÇÕES AUXILIARES DE RASTREAMENTO
        // ===================================================================

        // Função para gerar ID único (essencial para deduplicação)
        function generateEventId(prefix) {
            return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Função para obter cookies (fbp/fbc)
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        // ===================================================================
        // FUNÇÕES DE AÇÃO DO FORMULÁRIO
        // ===================================================================

        // ⚠️ 1. IMPLEMENTE ESTA FUNÇÃO para coletar os dados do formulário
        function collectFormData() {
            // EX: const email = document.getElementById('email').value;
            // EX: const cpf = document.getElementById('cpf').value;
            
            // Retorne um objeto com todos os dados do formulário
            return {
                email: 'teste@example.com', // Substitua
                cpf: '12345678900',         // Substitua
                nome: 'Nome do Lead',       // Substitua
                telefone: '11999999999',    // Substitua
                // ... outros campos do quiz (dataNascimento, orgaoEmpregador, etc.)
            };
        }

        // ⚠️ 2. IMPLEMENTE SUAS REGRAS DE PRÉ-QUALIFICAÇÃO AUTOMÁTICA AQUI
        function checkQuizPreQualification(dadosLead) {
            // Se o lead falhar em uma regra simples (ex: CPF inválido ou idade mínima)
            
            // Exemplo de regra (Remova ou ajuste conforme o seu quiz):
            // if (dadosLead.cpf.length !== 11) {
            //     return { isQualified: false, reason: 'cpf_invalido' };
            // }

            // Se passar nas regras simples, permite o envio.
            return { isQualified: true, reason: null };
        }
        
        // 3. ENVIA OS DADOS PARA O APPS SCRIPT (CAPI)
        function sendLeadFormSubmission(payload) {
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Necessário para Apps Script como web app
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(payload).toString()
            }).then(response => {
                // A resposta de Apps Script com 'no-cors' não pode ser lida
                console.log("POST enviado para Apps Script. Verifique logs do GAS para confirmação.");
            }).catch(error => {
                console.error('Erro ao enviar para Apps Script:', error);
            });
        }

        // 4. FLUXO PRINCIPAL DO FORMULÁRIO
        function handleSubmit(event) {
            event.preventDefault(); // Evita o envio padrão do formulário
            
            const dadosLead = collectFormData();
            const validation = checkQuizPreQualification(dadosLead);

            if (!validation.isQualified) {
                // DESQUALIFICAÇÃO NO NAVEGADOR (PIXEL)
                const eventId = generateEventId('disc_web');
                
                fbq('trackCustom', 'Lead_Disqualificado_PIXEL', 
                    { motivo: validation.reason },
                    { eventID: eventId }
                );
                
                // Mensagem de erro ou redirecionamento para página de desqualificação
                alert(`Desqualificado: ${validation.reason}. Não será salvo.`);
                return; 
            }

            // QUALIFICADO - CONTINUA O FLUXO DE LEAD
            sendLeadAndRedirect(dadosLead);
        }

        function sendLeadAndRedirect(dadosLead) {
            const eventId = generateEventId('web');
            const fbp = getCookie('_fbp') || '';
            const fbc = getCookie('_fbc') || '';

            // DISPARA EVENTO 'LEAD' (PIXEL)
            fbq('track', 'Lead', 
                { external_id: dadosLead.cpf.replace(/\D/g, '') }, 
                { eventID: eventId }
            );

            // MONTA O PAYLOAD PARA O APPS SCRIPT
            const payload = {
                ...dadosLead, 
                eventId: eventId, 
                fbp: fbp,         
                fbc: fbc          
            };

            // ENVIA PARA O APPS SCRIPT (Que disparará o LEAD CAPI)
            sendLeadFormSubmission(payload); 

            // REDIRECIONAMENTO (Sua lógica de sucesso)
            window.location.href = 'URL_DE_SUCESSO_OU_WHATSAPP'; 
        }

        // Adicionar o evento de submissão ao formulário (exemplo)
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('seuFormulario');
            if (form) {
                form.addEventListener('submit', handleSubmit);
            }
        });
    </script>
</head>
<body>
    <form id="seuFormulario">
        <input type="text" id="nome" name="nome" required placeholder="Nome">
        <input type="email" id="email" name="email" required placeholder="Email">
        <input type="text" id="cpf" name="cpf" required placeholder="CPF">
        <button type="submit">Enviar Quiz</button>
    </form>
</body>
</html>
