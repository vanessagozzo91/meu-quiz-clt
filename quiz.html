<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Crédito Expressa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/imask"></script>
    
    <script>
        // Pixel do Facebook (Mantenha o seu ID aqui)
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script','https://connect.facebook.com/en_US/fbevents.js');fbq('init', '1406224567314703');fbq('track', 'PageView');
    </script>
    <noscript>
        <img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1406224567314703&ev=PageView&noscript=1"/>
    </noscript>

    <style>
        /* Mantenha seu CSS aqui */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; margin:0; padding-top: 60px; padding-bottom: 60px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .hidden { display: none; }
        .form-card { max-width: 500px; width: 90%; margin: 0px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align:center; border: 1px solid #f0f4f7; }
        .orange-text-gradient { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .page-header-logo { margin-bottom: 20px; text-align: center; }
        .form-card .page-header-logo { margin-bottom: 30px; }
        .question h3 { font-size: 1.5rem; margin-bottom: 15px; font-weight: 600; color: #1f2937; }
        .step-indicator { font-size: 0.95rem; font-weight: 500; margin-bottom: 25px; color: #6b7280; }
        .option-btn { display:block; width:100%; padding:18px; margin-bottom:15px; border-radius:12px; background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%); border: none; cursor:pointer; font-weight: 700; font-size: 1.05rem; color: #ffffff; transition: all 0.3s; box-shadow: 0 6px 15px rgba(247, 147, 30, 0.4); line-height: 1.2; }
        .option-btn:hover { background: linear-gradient(90deg, #f7931e 0%, #ff6b35 100%); color: #ffffff; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(247, 147, 30, 0.5); }
        #cpf-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; background-color: #f9fafb; color: #1f2937; font-size: 1.1rem; margin-top: 15px; box-sizing: border-box; text-align: center; transition: border 0.3s, box-shadow 0.3s; }
        #cpf-error-message { color: #ef4444; font-size: 0.85rem; margin-top: 5px; font-weight: 500; }
        .title-message { font-size: 1.8rem; font-weight: 700; color: #ef4444; margin: 30px 0 15px; } 
        .result-text { color: #4b5563; } 
        .cta-btn { display: inline-flex; align-items: center; margin-top: 25px; padding: 15px 35px; background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%); color: white; border-radius: 12px; font-size: 1.15rem; font-weight: 700; text-decoration: none; transition: all 0.3s; box-shadow: 0 8px 20px rgba(247, 147, 30, 0.4); cursor: pointer; border: none; }
        .cta-btn:hover { background: linear-gradient(90deg, #f7931e 0%, #ff6b35 100%); box-shadow: 0 10px 25px rgba(247, 147, 30, 0.5); }
        .quiz-title { font-size: 1.5rem; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; color: #000; }
        .logo-text-bold { font-weight: 700; letter-spacing: 0.05em; }
        .logo-text-size { font-size: 1.5rem; }
        .text-center { text-align: center; }
        .leading-tight { line-height: 1.25; } 
        .text-sm { font-size: 0.875rem; }
        .mt-3 { margin-top: 0.75rem; }
        .text-gray-500 { color: #6b7280; }
        @media (max-width: 600px) {
            .form-card { padding: 20px; border-radius: 0; width: 100%; min-height: 100vh; margin: 0; box-shadow: none; }
            body { padding: 0; }
            .question h3 { font-size: 1.35rem; }
        }
    </style>
</head>
<body>
    
    <div class="form-card" id="formContainer">
        
        <div class="page-header-logo">
            <div class="text-center leading-tight">
                <span class="logo-text-size logo-text-bold text-black">ESPECIAL</span>
                <span class="logo-text-size logo-text-bold orange-text-gradient">CRÉDITO</span>
            </div>
        </div>

        <h1 class="quiz-title text-black">
            <span class="orange-text-gradient">Pré-Análise</span> Rápida
        </h1>
        
        <div id="step-info" class="step-indicator"></div>

        <div id="quizQuestions">
            <div id="question1" class="question" data-step="1" data-q-key="q1">
                <h3>Quantos meses você está registrado no seu emprego atual?</h3>
                <button class="option-btn" data-answer="Menos de 6 meses" onclick="nextQuestion(1, this)">Menos de 6 meses</button>
                <button class="option-btn" data-answer="6 meses ou mais" onclick="nextQuestion(1, this)">6 meses ou mais</button>
            </div>

            <div id="question2" class="question hidden" data-step="2" data-q-key="q2">
                <h3>Você já realizou algum empréstimo consignado CLT?</h3>
                <button class="option-btn" data-answer="Já realizei" onclick="nextQuestion(2, this)">Já realizei</button>
                <button class="option-btn" data-answer="Ainda não" onclick="nextQuestion(2, this)">Ainda não</button>
            </div>
            
            <div id="question3" class="question hidden" data-step="3">
                <h3>Sua pré-análise foi <span class="orange-text-gradient">aprovada</span>! Para realizar a simulação, informe seu <span class="orange-text-gradient">CPF</span>:</h3>
                
                <input type="text" id="cpf-input" placeholder="000.000.000-00" maxlength="14" required>
                <p id="cpf-error-message" class="hidden">Por favor, digite um CPF válido com 11 dígitos.</p>
                <p class="text-sm mt-3 text-gray-500">Seu CPF é usado apenas para a simulação com o consultor e não será armazenado sem consentimento.</p>
                
                <button class="cta-btn" id="cpf-btn">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" width="24" height="24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.516"/>
                    </svg>
                    REALIZAR SIMULAÇÃO
                </button>
            </div>
        </div>

        <div id="resultFail" class="hidden">
            <div class="title-message">PRÉ-ANÁLISE CONCLUÍDA</div>
            <p class="result-text text-lg">Obrigado pelo seu interesse! No momento, seu perfil não atende aos requisitos mínimos de crédito Consignado CLT.</p>
        </div>
    </div>
    
    <iframe name="iframeLeadTarget" id="iframeLeadTarget" style="display:none;"></iframe>

    <script>
        // ⭐️⭐️ POR FAVOR, CONFIRA ESTES DOIS VALORES! ⭐️⭐️
        const WHATSAPP_PHONE = '5514974000725'; 
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwl1aWk0XavXE2L7qwrk_3XNlJku6pK76ezVSJ8moyMCeo_PKQ96HFLh2NzGSikThxB/exec'; 
        // ⭐️⭐️ ----------------------------------------- ⭐️⭐️
        
        const totalSteps = 3; 
        let currentStep = 1;
        
        // Objeto de dados do quiz com TODOS os campos de rastreamento do Meta
        let quizData = {
            fbclid: '',
            utm_source: '',
            utm_campaign: '',
            ad_id: '',
            // NOVOS CAMPOS ADICIONADOS AQUI:
            utm_medium: '',
            utm_content: '',
            utm_term: '',
            placement: ''
        };
        
        const cpfInput = document.getElementById('cpf-input');
        const cpfBtn = document.getElementById('cpf-btn');
        const cpfErrorMsg = document.getElementById('cpf-error-message');

        // Máscara de CPF
        const cpfMask = IMask(cpfInput, { mask: '000.000.000-00' });

        function updateStepIndicator() {
            const stepElement = document.getElementById('step-info');
            const displayStep = Math.min(currentStep, totalSteps);
            stepElement.innerHTML = `Passo <span class="orange-text-gradient">${displayStep}</span> de ${totalSteps}`;
        }
        
        // ⭐️ FUNÇÃO CORRIGIDA PARA LER A QUERY STRING (?) ⭐️
        function readTrackingParamsFromQuery() {
            console.log("Iniciando leitura de parâmetros da URL (Query String)...");
            
            // Pega a string DEPOIS do ?
            const queryString = window.location.search;
            console.log("Query String encontrada na URL:", queryString);
            
            if (queryString) {
                // URLSearchParams é a forma correta de processar a string de parâmetros
                const urlParams = new URLSearchParams(queryString);
                
                // .get() vai buscar o valor de cada parâmetro
                quizData.fbclid = urlParams.get("fbclid") || '';
                quizData.utm_source = urlParams.get("utm_source") || '';
                quizData.utm_campaign = urlParams.get("utm_campaign") || '';
                quizData.ad_id = urlParams.get("ad_id") || urlParams.get("utm_id") || ''; // Captura ad_id ou utm_id
                
                // NOVOS CAMPOS LIDOS AQUI:
                quizData.utm_medium = urlParams.get("utm_medium") || '';
                quizData.utm_content = urlParams.get("utm_content") || '';
                quizData.utm_term = urlParams.get("utm_term") || '';
                quizData.placement = urlParams.get("placement") || '';
                
                console.log("SUCESSO: Parâmetros lidos e salvos no objeto quizData:", quizData);
            } else {
                console.log("AVISO: Nenhum parâmetro de rastreamento (?) encontrado na URL.");
            }
        }

        // Evento que roda assim que o conteúdo da página é carregado
        document.addEventListener('DOMContentLoaded', () => {
            // ✅ CORREÇÃO: Executa a leitura da Query String logo no carregamento
            readTrackingParamsFromQuery(); 
            updateStepIndicator();
        });

        function nextQuestion(step, button) {
            const answer = button.getAttribute('data-answer');
            
            if (step === 1 && answer === "Menos de 6 meses") {
                showFail();
                return;
            }
            if (step === 2 && answer === "Já realizei") {
                showFail();
                return;
            }

            document.getElementById(`question${step}`).classList.add('hidden');
            currentStep++;
            updateStepIndicator();
            
            if (currentStep <= totalSteps) {
                document.getElementById(`question${currentStep}`).classList.remove('hidden');
            }
        }
        
        function showCpfError(show) {
            if (show) {
                cpfInput.style.border = '2px solid #ef4444';
                cpfInput.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.5)';
                cpfErrorMsg.classList.remove('hidden');
                cpfInput.focus();
            } else {
                cpfInput.style.border = '1px solid #d1d5db';
                cpfInput.style.boxShadow = 'none';
                cpfErrorMsg.classList.add('hidden');
            }
        }

        cpfBtn.addEventListener('click', () => {
            const unmaskedCpf = cpfMask.unmaskedValue;
            
            if (unmaskedCpf.length === 11) {
                showCpfError(false);
                
                quizData['cpf'] = unmaskedCpf; 
                quizData['cpf_formatado'] = cpfMask.value; 

                sendLeadAndRedirect(); 
            } else {
                showCpfError(true);
            }
        });

        // FUNÇÃO FINAL DE ENVIO CAPI E REDIRECIONAMENTO
        
        function generateWhatsAppURL() {
            const cpfFormatado = quizData.cpf_formatado || 'Não Informado';
            const mensagemPura = `*PRÉ-APROVADO* ✅\n\nCPF para Simulação: ${cpfFormatado}\n\nOlá! Gostaria de falar com o consultor para realizar minha simulação de crédito.`;
            
            return `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(mensagemPura)}`;
        }

        function redirectToWhatsApp() {
            const whatsappUrl = generateWhatsAppURL();
            
            // Tenta abrir em uma nova aba, que é a melhor experiência
            const newWindow = window.open(whatsappUrl, '_blank'); 
            
            // Fallback caso o pop-up seja bloqueado
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                window.location.href = whatsappUrl;
            }
        }

        function sendLeadFormSubmission(dadosLead) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = APPS_SCRIPT_URL;
            form.target = 'iframeLeadTarget'; 
            form.style.display = 'none';

            // Inclui o Timestamp e o URL de origem para melhor rastreio
            dadosLead.timestamp_local = new Date().toLocaleString('pt-BR');
            dadosLead.page_url = window.location.href;

            for (const key in dadosLead) {
                if (dadosLead.hasOwnProperty(key)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = dadosLead[key];
                    form.appendChild(input);
                }
            }

            document.body.appendChild(form);
            form.submit();
            console.log('Dados do Lead enviados para a planilha via formulário:', dadosLead);
            
            setTimeout(() => form.remove(), 1000);
        }

        function sendLeadAndRedirect() {
            // 1. DISPARA O EVENTO DE LEAD NO PIXEL (Navegador) 
            fbq('track', 'Lead'); 
            
            // Monta o objeto final de dados com todos os parâmetros de rastreamento
            const dadosLead = {
                cpf: quizData.cpf || '', 
                fbclid: quizData.fbclid || '',
                utm_source: quizData.utm_source || '',
                utm_campaign: quizData.utm_campaign || '',
                ad_id: quizData.ad_id || '',
                // NOVOS CAMPOS INCLUÍDOS AQUI
                utm_medium: quizData.utm_medium || '',
                utm_content: quizData.utm_content || '',
                utm_term: quizData.utm_term || '',
                placement: quizData.placement || '',
                // FIM DOS NOVOS CAMPOS
                user_agent: navigator.userAgent
            };
            
            // PONTO DE VERIFICAÇÃO CRÍTICO
            console.log("Objeto 'dadosLead' que será enviado para a planilha:", dadosLead);

            // 2. ENVIA LEAD PARA O APPS SCRIPT
            sendLeadFormSubmission(dadosLead);

            // 3. REDIRECIONA PARA O WHATSAPP (com um pequeno delay para garantir o envio)
            setTimeout(() => {
                redirectToWhatsApp();
            }, 500);
        }

        function showFail() {
            document.getElementById('quizQuestions').classList.add('hidden');
            document.getElementById('step-info').classList.add('hidden');
            document.getElementById('resultFail').classList.remove('hidden');
            fbq('trackCustom', 'QuizReprovado'); 
        }
    </script>
</body>
</html>
